<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Film Stream</title>
    <link rel="stylesheet" href="admin.css">
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.0/css/line.css">
</head>

<body>
    <%- include('../components/ad_sidebar') %>

    <section class="dashboard">
        <div class="top">
            <i class="uil uil-bars sidebar-toggle"></i>
            <div class="search-box">
                <i class="uil uil-search"></i>
                <form>
                    <input type="text" name="search" placeholder="Search here...">
                </form>
            </div>
        </div>

        <div class="dash-content">
            <% if (error2.length > 0) { %>
                <div class="flash-message error">
                    <%= error2 %>
                </div>
            <% } %>

            <% if (success2.length > 0) { %>
                <div class="flash-message success">
                    <%= success2 %>
                </div>
            <% } %>
            <div class="activity">
                <div class="title">
                    <i class="uil uil-users-alt"></i>
                    <span class="text">Avatar List</span>
                    <a href="#" class="btn-add">+ Add Avatar</a>
                </div>

                <!-- Tabela de Avatares -->
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col">Image</th>
                                <th scope="col">Name</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% avatars.forEach(avatar => { %>
                                <tr>
                                    <td>
                                        <img src="<%= avatar.avatar_url %>" alt="<%= avatar.avatar_name %>" width="50" height="50">
                                    </td>
                                    <td>
                                        <%= avatar.avatar_name %>
                                    </td>
                                    <td>
                                        <button class="btn-edit action-btn btn-edit-color" data-id="<%= avatar._id %>" data-name="<%= avatar.avatar_name %>" data-image="<%= avatar.avatar_url %>">
                                            <i class="uil uil-pen"></i>
                                        </button>
                                        <button type="submit" class="btn-delete action-btn btn-delete-color" data-id="<%= avatar._id %>">
                                            <i class="uil uil-trash-alt"></i>
                                        </button>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
                <div class="pagination">
                    <% if (currentPage > 1) { %>
                        <a href="/ad_avatar?page=<%= currentPage - 1 %>&search=<%= searchQuery %>">
                            <i class="uil uil-arrow-left"></i> Previous
                        </a>
                    <% } %>
                    <% for (let i = 1; i <= totalPages; i++) { %>
                        <a href="/ad_avatar?page=<%= i %>&search=<%= searchQuery %>" class="<%= currentPage === i ? 'active' : '' %>">
                            <%= i %>
                        </a>
                    <% } %>
                    <% if (currentPage < totalPages) { %>
                        <a href="/ad_avatar?page=<%= currentPage + 1 %>&search=<%= searchQuery %>" class="next-button">
                            Next <i class="uil uil-arrow-right"></i>
                        </a>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- Popup Add Avatar -->
        <div class="popup_add" id="popup_add">
            <div class="popup_add-content">
                <h2>Add Avatar</h2>
                <form action="/create-avatar" method="post" enctype="multipart/form-data">
                    <label for="avatar-file">Avatar Image:</label>
                    <input type="file" id="avatar-file" name="avatar" accept="image/*" required>

                    <label for="avatar-name">Avatar Name:</label>
                    <input type="text" id="avatar-name" name="avatar_name" placeholder="Enter the avatar name" required>

                    <button type="submit" class="btn-submit">Add Avatar</button>
                    <button class="btn-cancel-add" onclick="closePopup()">Cancel</button>
                </form>
            </div>
        </div>

        <!-- Popup Delete Avatar -->
        <div class="popup_add" id="popup-delete">
            <div class="popup_add-content">
                <h2>Confirm Delete</h2>
                <p>Are you sure you want to delete this item?</p>
                <form id="delete-avatar-form" method="post">
                    <div class="popup_add-buttons">
                        <button class="btn-confirm-delete">Yes, Delete</button>
                        <button class="btn-cancel-delete" onclick="closePopup()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Popup Edit Avatar -->
        <div class="popup_add" id="popup-edit">
            <div class="popup_add-content">
                <h2>Edit Avatar</h2>
                <form id="edit-avatar-form" method="post" enctype="multipart/form-data">
                    <input type="hidden" id="edit-avatar-id" name="id">

                    <label for="edit-avatar-file">New Avatar Image:</label>
                    <input type="file" id="edit-avatar-file" name="avatar">

                    <label for="edit-avatar-name">Avatar Name:</label>
                    <input type="text" id="edit-avatar-name" name="name" required>

                    <div class="popup_add-buttons">
                        <button type="submit" class="btn-submit">Save Changes</button>
                        <button class="btn-cancel-edit" onclick="closePopup()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <script>
        // Sidebar Toggle
        const body = document.querySelector("body"),
            sidebar = body.querySelector("nav"),
            sidebarToggle = body.querySelector(".sidebar-toggle");

        if (localStorage.getItem("status") === "close") {
            sidebar.classList.add("close");
        }

        sidebarToggle.addEventListener("click", () => {
            sidebar.classList.toggle("close");
            localStorage.setItem("status", sidebar.classList.contains("close") ? "close" : "open");
        });

        // Função para abrir popups
        function openPopup(buttonSelector, popupElement) {
            document.querySelectorAll(buttonSelector).forEach(button => {
                button.addEventListener("click", (e) => {
                    e.preventDefault();
                    popupElement.style.display = "flex";
                });
            });
        }

        // Função para fechar o popup ao clicar fora dele
        function closePopupOnClickOutside(popupElement) {
            window.addEventListener("click", (e) => {
                if (e.target === popupElement) {
                    popupElement.style.display = "none";
                }
            });
        }

        // Função para fechar o popup ao clicar no botão de cancelar
        function closePopupOnCancel(buttonSelector, popupElement) {
            document.querySelector(buttonSelector).addEventListener("click", (e) => {
                e.preventDefault();
                popupElement.style.display = "none";
            });
        }

        // Inicializando Popups
        const popupAdd = document.getElementById("popup_add");
        const popupDelete = document.getElementById("popup-delete");
        const popupEdit = document.getElementById("popup-edit");

        openPopup(".btn-add", popupAdd);
        openPopup(".btn-edit", popupEdit);

        document.querySelectorAll(".btn-delete").forEach(button => {
            button.addEventListener("click", (e) => {
                e.preventDefault();
                const avatarId = button.getAttribute('data-id');
                const deleteForm = document.getElementById('delete-avatar-form');
                deleteForm.action = `/delete-avatar/${avatarId}`;
                popupDelete.style.display = "flex";
            });
        });

        // Abrir popup de edição e preencher os campos
        document.querySelectorAll(".btn-edit").forEach(button => {
            button.addEventListener("click", (e) => {
                e.preventDefault();
                const id = button.dataset.id;
                const name = button.dataset.name;
                const image = button.dataset.image;

                document.getElementById("edit-avatar-id").value = id;
                document.getElementById("edit-avatar-name").value = name;
                document.getElementById("edit-avatar-form").action = `/update-avatar/${id}`;

                popupEdit.style.display = "flex";
            });
        });

        // Fechar ao clicar fora do popup
        closePopupOnClickOutside(popupAdd);
        closePopupOnClickOutside(popupDelete);
        closePopupOnClickOutside(popupEdit);

        // Fechar ao clicar no botão de cancelar
        closePopupOnCancel(".btn-cancel-delete", popupDelete);
        closePopupOnCancel(".btn-cancel-edit", popupEdit);
        closePopupOnCancel(".btn-cancel-add", popupAdd); // Adicionando evento para o botão de cancelar do popup de adicionar

        // Esconder mensagens flash após 3 segundos
        setTimeout(() => {
            const flashMessage = document.querySelector(".flash-message");
            if (flashMessage) {
                flashMessage.style.display = "none";
            }
        }, 3000);
    </script>
</body>

</html>