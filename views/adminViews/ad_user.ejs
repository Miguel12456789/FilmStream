<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Film Stream</title>
    <link rel="stylesheet" href="admin.css">
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.0/css/line.css">
</head>

<body>
    <%- include('../components/ad_sidebar') %>

        <section class="dashboard">
            <div class="top">
                <i class="uil uil-bars sidebar-toggle"></i>
                <div class="search-box">
                    <i class="uil uil-search"></i>
                    <form>
                        <input type="text" name="search" placeholder="Search here...">
                    </form>
                </div>
            </div>
            <div class="dash-content">
                <% if (error2.length> 0) { %>
                    <div class="flash-message error">
                        <%= error2 %>
                    </div>
                    <% } %>

                        <% if (success2.length> 0) { %>
                            <div class="flash-message success">
                                <%= success2 %>
                            </div>
                            <% } %>
                                <div class="activity">
                                    <div class="title">
                                        <i class="uil uil-user"></i>
                                        <span class="text">User List</span>
                                        <a href="#" class="btn-add">+ Add User</a>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th scope="col">Img</th>
                                                    <th scope="col">Name</th>
                                                    <th scope="col">Email</th>
                                                    <th scope="col">Admin</th>
                                                    <th scope="col">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% users.forEach(user=> { %>
                                                    <tr>
                                                        <!-- Exibir a imagem do avatar -->
                                                        <td>
                                                            <% if (user.avatar_id && user.avatar_id.avatar_url) { %>
                                                                <img src="<%= user.avatar_id.avatar_url %>" alt="Avatar"
                                                                    width="50" height="50" style="border-radius: 50%;">
                                                                <% } else { %>
                                                                    <img src="/images/default-avatar.png"
                                                                        alt="Default Avatar" width="50" height="50"
                                                                        style="border-radius: 50%;">
                                                                    <% } %>
                                                        </td>
                                                        <td>
                                                            <%= user.name %>
                                                        </td>
                                                        <td>
                                                            <%= user.email %>
                                                        </td>
                                                        <td>
                                                            <%= user.isAdmin ? 'Yes' : 'No' %>
                                                        </td>
                                                        <td>
                                                            <button class="btn-edit action-btn btn-edit-color">
                                                                <i class="uil uil-pen"></i>
                                                            </button>
                                                            <button class="btn-delete action-btn btn-delete-color"
                                                                data-id="<%= user._id %>">
                                                                <i class="uil uil-trash-alt"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    <% }) %>
                                            </tbody>
                                        </table>
                                    </div>
                                    <!-- Pagination -->
                                    <div class="pagination">
                                        <% if (currentPage> 1) { %>
                                            <a href="/ad_user?page=<%= currentPage - 1 %>&search=<%= searchQuery %>">
                                                <i class="uil uil-arrow-left"></i> Previous
                                            </a>
                                            <% } %>
                                                <% for (let i=1; i <=totalPages; i++) { %>
                                                    <a href="/ad_user?page=<%= i %>&search=<%= searchQuery %>"
                                                        class="<%= currentPage === i ? 'active' : '' %>">
                                                        <%= i %>
                                                    </a>
                                                    <% } %>
                                                        <% if (currentPage < totalPages) { %>
                                                            <a href="/ad_user?page=<%= currentPage + 1 %>&search=<%= searchQuery %>"
                                                                class="next-button">
                                                                Next <i class="uil uil-arrow-right"></i>
                                                            </a>
                                                            <% } %>

                                    </div>
                                </div>
            </div>
            <!-- Add -->
            <div class="popup_add" id="popup_add">
                <div class="popup_add-content">
                    <h2>Add User</h2>
                    <form action="/create-user" method="post">
                        <label for="user-name">User Name:</label>
                        <input type="text" id="add-user-name" name="name" placeholder="Enter the name" required>
                        <label for="add-user-email">User Email:</label>
                        <input type="text" id="add-user-email" name="email" placeholder="Enter the email" required>
                        <label for="add-user-password">User Password:</label>
                        <input type="password" id="add-user-password" name="password" placeholder="Enter the password"
                            required>
                        <div class="checkbox-container">
                            <input type="checkbox" id="isAdmin" name="isAdmin" class="ui-checkbox" value="true">
                            <label for="isAdmin">Is Admin</label>
                        </div>
                        <button type="submit" class="btn-submit">Add User</button>
                        <button class="btn-cancel-add" onclick="closePopup()">Cancel</button>

                    </form>
                </div>
            </div>
            <!-- Delete -->
            <div class="popup_add" id="popup-delete">
                <div class="popup_add-content">
                    <h2>Confirm Delete</h2>
                    <p>Are you sure you want to delete this item?</p>
                    <form id="delete-user-form" method="post">
                        <div class="popup_add-buttons">
                            <button class="btn-confirm-delete">Yes, Delete</button>
                            <button class="btn-cancel-delete" onclick="closePopup()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
            <!-- <% users.forEach(user=> { %> value="<%= user.name %>"  value="<%= user.email %>"-->
            <!-- Edit -->
            <div class="popup_add" id="popup-edit">
                <div class="popup_add-content">
                    <h2>Edit user</h2>
                    <form id="edit-user-form" method="post">
                        <input type="hidden" id="edit-user-id" name="id">
                        <label for="edit-user-name">User Name:</label>
                        <input type="text" id="edit-user-name" name="name" placeholder="Enter the new name" required>
                        <label for="edit-user-email">User Email:</label>
                        <input type="email" id="edit-user-email" name="email" placeholder="Enter the new email"
                            required>
                        <div class="checkbox-container">
                            <input type="checkbox" id="isAdmin" name="isAdmin" class="ui-checkbox" value="true">
                            <label for="isAdmin">Is Admin</label>
                        </div>
                        <div class="popup_add-buttons">
                            <button type="submit" class="btn-submit">Save Changes</button>
                            <button class="btn-cancel-edit" onclick="closePopup()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
            <!-- <% }) %> -->
        </section>
        <script>
            // Sidebar Toggle
            const body = document.querySelector("body"),
                sidebar = body.querySelector("nav"),
                sidebarToggle = body.querySelector(".sidebar-toggle");

            if (localStorage.getItem("status") === "close") {
                sidebar.classList.add("close");
            }

            sidebarToggle.addEventListener("click", () => {
                sidebar.classList.toggle("close");
                localStorage.setItem("status", sidebar.classList.contains("close") ? "close" : "open");
            });

            // Função para abrir o popup
            function openPopup(buttonSelector, popupElement) {
                document.querySelectorAll(buttonSelector).forEach(button => {
                    button.addEventListener("click", (e) => {
                        e.preventDefault();
                        popupElement.style.display = "flex";
                    });
                });
            }

            // Função para fechar o popup ao clicar fora dele
            function closePopupOnClickOutside(popupElement) {
                window.addEventListener("click", (e) => {
                    if (e.target === popupElement) {
                        popupElement.style.display = "none";
                    }
                });
            }

            // Função para fechar o popup ao clicar no botão de cancelar
            function closePopupOnCancel(buttonSelector, popupElement) {
                document.querySelector(buttonSelector).addEventListener("click", (e) => {
                    e.preventDefault();
                    popupElement.style.display = "none";
                });
            }

            // Inicializando Popups
            const popupAdd = document.getElementById("popup_add");
            const popupDelete = document.getElementById("popup-delete");
            const popupEdit = document.getElementById("popup-edit");

            openPopup(".btn-add", popupAdd);
            openPopup(".btn-edit", popupEdit); // AGORA FUNCIONA PARA TODOS OS BOTÕES DE EDITAR

            document.querySelectorAll(".btn-delete").forEach(button => {
                button.addEventListener("click", (e) => {
                    e.preventDefault();
                    const userId = button.getAttribute('data-id');
                    const deleteForm = document.getElementById('delete-user-form');
                    deleteForm.action = `/delete-user/${userId}`;
                    popupDelete.style.display = "flex";
                });
            });

            
            document.querySelectorAll(".btn-edit").forEach(button => {
                button.addEventListener("click", (e) => {
                    e.preventDefault();
                    const userId = button.closest('tr').querySelector('.btn-delete').getAttribute('data-id');
                    const userName = button.closest('tr').querySelector('td:nth-child(2)').innerText;
                    const userEmail = button.closest('tr').querySelector('td:nth-child(3)').innerText;
                    document.getElementById('edit-user-id').value = userId;
                    document.getElementById('edit-user-name').value = userName;
                    document.getElementById('edit-user-email').value = userEmail;
                    document.getElementById('edit-user-form').action = `/update-user/${userId}`;
                    popupEdit.style.display = "flex";
                });
            });



            // Fechar ao clicar fora
            closePopupOnClickOutside(popupAdd);
            closePopupOnClickOutside(popupDelete);
            closePopupOnClickOutside(popupEdit);

            // Fechar ao clicar no botão de cancelar
            closePopupOnCancel(".btn-cancel-delete", popupDelete);
            closePopupOnCancel(".btn-cancel-edit", popupEdit);
            closePopupOnCancel(".btn-cancel-add", popupAdd); // Adicionando evento para o botão de cancelar do popup de adicionar


            // Esconder mensagens flash após 3 segundos
            setTimeout(() => {
                const flashMessage = document.querySelector(".flash-message");
                if (flashMessage) {
                    flashMessage.style.display = "none";
                }
            }, 3000);
        </script>
</body>

</html>